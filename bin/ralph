#!/bin/bash
# Ralph Wiggum - Autonomous AI Coding Loop
# Usage: ralph <max_iterations> | ralph --once | ralph --init | ralph --reset | ralph --clean | ralph --plan [--max-tasks N] [description]

RALPH_VERSION='1.4.0'
RALPH_REPO='CorepanyDev/homebrew-ralph'
#
# This script runs Claude Code in a loop, working through a PRD (Product Requirements Document)
# one task at a time. Each iteration:
# 1. Reads prd.json and progress.txt
# 2. Picks the highest priority incomplete task
# 3. Implements, tests, and verifies
# 4. Updates PRD and progress.txt
# 5. Commits to git
# 6. Repeats until PRD is complete or max iterations reached

set -e

# Configuration - Uses current working directory
SCRIPT_DIR="$(pwd)"
PRD_FILE="${SCRIPT_DIR}/prd.json"
PROGRESS_FILE="${SCRIPT_DIR}/progress.txt"
PROJECT_REQUEST_FILE="${SCRIPT_DIR}/project-request.md"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to create template files
init_templates() {
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}  Ralph Wiggum - Initialize Project    ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""

    # Create prd.json template
    if [ -f "$PRD_FILE" ]; then
        echo -e "${YELLOW}prd.json already exists, skipping...${NC}"
    else
        cat > "$PRD_FILE" << 'EOF'
[
  {
    "id": 1,
    "description": "Example: User authentication with email/password",
    "acceptance_criteria": [
      "Login form displays email and password fields",
      "Successful login redirects to dashboard",
      "Invalid credentials show error message",
      "Password is securely hashed"
    ],
    "priority": "high",
    "passes": false
  },
  {
    "id": 2,
    "description": "Example: User can view their profile",
    "acceptance_criteria": [
      "Profile page shows user's name and email",
      "Profile is only accessible when logged in",
      "Unauthorized access redirects to login"
    ],
    "priority": "medium",
    "passes": false
  },
  {
    "id": 3,
    "description": "Example: User can update their profile",
    "acceptance_criteria": [
      "Edit form pre-fills current values",
      "Changes are saved to database",
      "Success message appears after save",
      "Validation errors display inline"
    ],
    "priority": "medium",
    "passes": false
  }
]
EOF
        echo -e "${GREEN}Created: ${PRD_FILE}${NC}"
    fi

    # Create progress.txt template
    if [ -f "$PROGRESS_FILE" ]; then
        echo -e "${YELLOW}progress.txt already exists, skipping...${NC}"
    else
        cat > "$PROGRESS_FILE" << 'EOF'
# Ralph Progress Log
# This file tracks learnings and notes across iterations
# The LLM appends to this file after each task completion
# Delete this file when starting a new sprint

## Sprint: [Sprint Name]
## Started: [Date]

---
EOF
        echo -e "${GREEN}Created: ${PROGRESS_FILE}${NC}"
    fi

    # Create project-request.md template
    if [ -f "$PROJECT_REQUEST_FILE" ]; then
        echo -e "${YELLOW}project-request.md already exists, skipping...${NC}"
    else
        cat > "$PROJECT_REQUEST_FILE" << 'EOF'
# Project Request

## Overview
Describe your project idea here. What are you building? What problem does it solve?

## Features
- Feature 1: Description
- Feature 2: Description
- Feature 3: Description

## Technical Requirements
- Any specific technologies or frameworks to use
- Performance requirements
- Security considerations

## User Stories
Describe the main user flows and interactions.

## Notes
Any additional context or constraints.
EOF
        echo -e "${GREEN}Created: ${PROJECT_REQUEST_FILE}${NC}"
    fi

    echo ""
    echo -e "${GREEN}Initialization complete!${NC}"
    echo ""
    echo -e "Next steps:"
    echo -e "  1. Edit ${YELLOW}project-request.md${NC} with your project idea"
    echo -e "  2. Run ${YELLOW}ralph --plan${NC} to generate prd.json"
    echo -e "  3. Review and adjust ${YELLOW}prd.json${NC} if needed"
    echo -e "  4. Run ${YELLOW}ralph <max_iterations>${NC} to start coding"
    echo ""
    exit 0
}

# Function to reset template files to initial state
reset_templates() {
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}  Ralph Wiggum - Reset Project         ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""
    echo -e "${YELLOW}This will reset the following files to their template state:${NC}"
    echo -e "  - ${PRD_FILE}"
    echo -e "  - ${PROGRESS_FILE}"
    echo -e "  - ${PROJECT_REQUEST_FILE}"
    echo ""
    echo -e "${RED}WARNING: Any existing content in these files will be lost!${NC}"
    echo ""

    # Prompt for confirmation
    read -r -p "Are you sure you want to reset? (y/N) " response
    case "$response" in
        [yY][eE][sS]|[yY])
            ;;
        *)
            echo ""
            echo -e "${YELLOW}Reset cancelled.${NC}"
            exit 0
            ;;
    esac

    echo ""

    # Reset prd.json
    cat > "$PRD_FILE" << 'EOF'
[
  {
    "id": 1,
    "description": "Example: User authentication with email/password",
    "acceptance_criteria": [
      "Login form displays email and password fields",
      "Successful login redirects to dashboard",
      "Invalid credentials show error message",
      "Password is securely hashed"
    ],
    "priority": "high",
    "passes": false
  },
  {
    "id": 2,
    "description": "Example: User can view their profile",
    "acceptance_criteria": [
      "Profile page shows user's name and email",
      "Profile is only accessible when logged in",
      "Unauthorized access redirects to login"
    ],
    "priority": "medium",
    "passes": false
  },
  {
    "id": 3,
    "description": "Example: User can update their profile",
    "acceptance_criteria": [
      "Edit form pre-fills current values",
      "Changes are saved to database",
      "Success message appears after save",
      "Validation errors display inline"
    ],
    "priority": "medium",
    "passes": false
  }
]
EOF
    echo -e "${GREEN}Reset: ${PRD_FILE}${NC}"

    # Reset progress.txt
    cat > "$PROGRESS_FILE" << 'EOF'
# Ralph Progress Log
# This file tracks learnings and notes across iterations
# The LLM appends to this file after each task completion
# Delete this file when starting a new sprint

## Sprint: [Sprint Name]
## Started: [Date]

---
EOF
    echo -e "${GREEN}Reset: ${PROGRESS_FILE}${NC}"

    # Reset project-request.md
    cat > "$PROJECT_REQUEST_FILE" << 'EOF'
# Project Request

## Overview
Describe your project idea here. What are you building? What problem does it solve?

## Features
- Feature 1: Description
- Feature 2: Description
- Feature 3: Description

## Technical Requirements
- Any specific technologies or frameworks to use
- Performance requirements
- Security considerations

## User Stories
Describe the main user flows and interactions.

## Notes
Any additional context or constraints.
EOF
    echo -e "${GREEN}Reset: ${PROJECT_REQUEST_FILE}${NC}"

    echo ""
    echo -e "${GREEN}Reset complete!${NC}"
    echo ""
    echo -e "Next steps:"
    echo -e "  1. Edit ${YELLOW}project-request.md${NC} with your project idea"
    echo -e "  2. Run ${YELLOW}ralph --plan${NC} to generate prd.json"
    echo -e "  3. Review and adjust ${YELLOW}prd.json${NC} if needed"
    echo -e "  4. Run ${YELLOW}ralph <max_iterations>${NC} to start coding"
    echo ""
    exit 0
}

# Function to clean (remove) template files
clean_templates() {
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}  Ralph Wiggum - Clean Project         ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""
    echo -e "${YELLOW}This will remove the following Ralph template files:${NC}"

    local files_to_remove=()

    if [ -f "$PRD_FILE" ]; then
        echo -e "  - ${PRD_FILE}"
        files_to_remove+=("$PRD_FILE")
    fi

    if [ -f "$PROGRESS_FILE" ]; then
        echo -e "  - ${PROGRESS_FILE}"
        files_to_remove+=("$PROGRESS_FILE")
    fi

    if [ -f "$PROJECT_REQUEST_FILE" ]; then
        echo -e "  - ${PROJECT_REQUEST_FILE}"
        files_to_remove+=("$PROJECT_REQUEST_FILE")
    fi

    if [ ${#files_to_remove[@]} -eq 0 ]; then
        echo ""
        echo -e "${GREEN}No Ralph template files found to clean.${NC}"
        exit 0
    fi

    echo ""
    echo -e "${RED}WARNING: These files will be permanently deleted!${NC}"
    echo ""

    # Prompt for confirmation
    read -r -p "Are you sure you want to clean? (y/N) " response
    case "$response" in
        [yY][eE][sS]|[yY])
            ;;
        *)
            echo ""
            echo -e "${YELLOW}Clean cancelled.${NC}"
            exit 0
            ;;
    esac

    echo ""

    for file in "${files_to_remove[@]}"; do
        rm -f "$file"
        echo -e "${GREEN}Removed: ${file}${NC}"
    done

    echo ""
    echo -e "${GREEN}Clean complete!${NC}"
    echo ""
    exit 0
}

# Function to get latest version from GitHub API
get_latest_version() {
    local latest_version
    latest_version=$(curl -s "https://api.github.com/repos/${RALPH_REPO}/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v?([^"]+)".*/\1/')
    if [ -z "$latest_version" ]; then
        # Fallback: try to get from tags if no releases
        latest_version=$(curl -s "https://api.github.com/repos/${RALPH_REPO}/tags" | grep '"name":' | head -1 | sed -E 's/.*"v?([^"]+)".*/\1/')
    fi
    echo "$latest_version"
}

# Function to detect if installed via Homebrew
is_homebrew_install() {
    local script_path
    script_path=$(realpath "$0" 2>/dev/null || readlink -f "$0" 2>/dev/null || echo "$0")
    if [[ "$script_path" == */Cellar/* ]] || [[ "$script_path" == */homebrew/* ]] || [[ "$script_path" == */linuxbrew/* ]]; then
        return 0
    fi
    return 1
}

# Check for --version flag
if [ "$1" = "--version" ] || [ "$1" = "-v" ]; then
    echo "ralph version ${RALPH_VERSION}"
    exit 0
fi

# Check for --update flag
if [ "$1" = "--update" ] || [ "$1" = "-u" ]; then
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}  Ralph Wiggum - Update Check          ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""

    # Check if installed via Homebrew
    if is_homebrew_install; then
        echo -e "${YELLOW}Ralph was installed via Homebrew.${NC}"
        echo ""
        echo -e "Please update using: ${GREEN}brew upgrade ralph${NC}"
        echo ""
        exit 0
    fi

    echo -e "Checking for updates..."
    echo ""

    LATEST_VERSION=$(get_latest_version)

    if [ -z "$LATEST_VERSION" ]; then
        echo -e "${RED}Error: Could not fetch latest version from GitHub.${NC}"
        echo "Please check your internet connection and try again."
        exit 1
    fi

    echo -e "Current version: ${YELLOW}${RALPH_VERSION}${NC}"
    echo -e "Latest version:  ${YELLOW}${LATEST_VERSION}${NC}"
    echo ""

    if [ "$RALPH_VERSION" = "$LATEST_VERSION" ]; then
        echo -e "${GREEN}You are already on the latest version!${NC}"
        exit 0
    fi

    echo -e "${YELLOW}A new version is available!${NC}"
    echo ""

    # Prompt for confirmation
    read -r -p "Do you want to update? (y/N) " response
    case "$response" in
        [yY][eE][sS]|[yY])
            ;;
        *)
            echo ""
            echo -e "${YELLOW}Update cancelled.${NC}"
            exit 0
            ;;
    esac

    echo ""
    echo -e "Downloading ralph v${LATEST_VERSION}..."

    # Get the path to the current script
    SCRIPT_PATH=$(realpath "$0" 2>/dev/null || readlink -f "$0" 2>/dev/null || echo "$0")

    # Download new version to a temporary file
    TEMP_FILE=$(mktemp)
    DOWNLOAD_URL="https://raw.githubusercontent.com/${RALPH_REPO}/v${LATEST_VERSION}/bin/ralph"

    if ! curl -fsSL "$DOWNLOAD_URL" -o "$TEMP_FILE" 2>/dev/null; then
        rm -f "$TEMP_FILE"
        echo -e "${RED}Error: Failed to download update from GitHub.${NC}"
        echo "URL: $DOWNLOAD_URL"
        echo "Please check your internet connection and try again."
        exit 1
    fi

    # Verify the downloaded file is not empty and looks like a shell script
    if [ ! -s "$TEMP_FILE" ] || ! head -1 "$TEMP_FILE" | grep -q "^#!/"; then
        rm -f "$TEMP_FILE"
        echo -e "${RED}Error: Downloaded file appears to be invalid.${NC}"
        echo "Please try again or update manually."
        exit 1
    fi

    # Preserve permissions from original script
    ORIGINAL_PERMS=$(stat -f "%OLp" "$SCRIPT_PATH" 2>/dev/null || stat -c "%a" "$SCRIPT_PATH" 2>/dev/null)

    # Replace the current script with the new version
    if ! mv "$TEMP_FILE" "$SCRIPT_PATH" 2>/dev/null; then
        rm -f "$TEMP_FILE"
        echo -e "${RED}Error: Could not replace script. You may need sudo permissions.${NC}"
        echo "Try: sudo ralph --update"
        exit 1
    fi

    # Restore permissions
    chmod "$ORIGINAL_PERMS" "$SCRIPT_PATH" 2>/dev/null || chmod +x "$SCRIPT_PATH"

    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}  Successfully updated to v${LATEST_VERSION}!${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    exit 0
fi

# Check for --init flag
if [ "$1" = "--init" ] || [ "$1" = "-i" ]; then
    init_templates
fi

# Check for --reset flag
if [ "$1" = "--reset" ] || [ "$1" = "-r" ]; then
    reset_templates
fi

# Check for --clean flag
if [ "$1" = "--clean" ] || [ "$1" = "-c" ]; then
    clean_templates
fi

# Check for --once flag (single iteration interactive mode)
if [ "$1" = "--once" ] || [ "$1" = "-o" ]; then
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}  Ralph Wiggum - Single Iteration Mode ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""

    # Validate required files exist
    if [ ! -f "$PRD_FILE" ]; then
        echo -e "${RED}Error: PRD file not found at ${PRD_FILE}${NC}"
        echo "Run 'ralph --init' to create template files, then 'ralph --plan' to generate PRD."
        exit 1
    fi

    # Create progress.txt if it doesn't exist
    if [ ! -f "$PROGRESS_FILE" ]; then
        echo "# Ralph Progress Log" > "$PROGRESS_FILE"
        echo "# This file tracks learnings across iterations" >> "$PROGRESS_FILE"
        echo "" >> "$PROGRESS_FILE"
    fi

    echo -e "PRD File: ${YELLOW}${PRD_FILE}${NC}"
    echo -e "Progress File: ${YELLOW}${PROGRESS_FILE}${NC}"
    echo ""
    echo -e "${YELLOW}Starting interactive Claude session...${NC}"
    echo ""

    # Single iteration prompt optimized for interactive mode
    SINGLE_PROMPT="You are working through a Product Requirements Document (PRD).

Read these files first:
- ${PRD_FILE} - The PRD with user stories (items with passes: false need work)
- ${PROGRESS_FILE} - Your progress log from previous iterations

Your workflow:
1. Find the HIGHEST PRIORITY feature that has passes: false
   - Priority is determined by you based on dependencies and logical order
   - NOT necessarily the first item in the list
2. Work ONLY on that single feature
3. Implement the feature following best practices for the language/framework used
4. Verify your work:
   - Run type checking/linting appropriate for the language
   - Run tests appropriate for the framework
   - Ensure all checks pass before marking complete
5. Update the PRD: set passes: true for completed items
6. APPEND your progress to ${PROGRESS_FILE}
   - Include what you did, decisions made, and notes for next iteration
   - APPEND only, never replace the file contents
7. Make a git commit with a descriptive message

IMPORTANT:
- Work on ONE feature at a time only
- Follow best practices for the language and framework in use
- Ensure CI stays green (all checks and tests pass)
- Do NOT add Co-Authored-By or any AI attribution in commit messages
- Do NOT commit Ralph template files (prd.json, progress.txt, project-request.md) - these are local workflow files

When you have completed the task, let the user know you are done."

    # Run Claude interactively (no -p flag = interactive mode, user watches in real-time)
    (cd "$SCRIPT_DIR" && claude --dangerously-skip-permissions "$SINGLE_PROMPT")

    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}  Single iteration complete!           ${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    exit 0
fi

# Check for --plan flag
if [ "$1" = "--plan" ] || [ "$1" = "-p" ]; then
    shift # consume --plan/-p

    # Parse --max-tasks and inline description from remaining args
    MAX_TASKS=30
    INLINE_DESC=""

    while [ $# -gt 0 ]; do
        case "$1" in
            --max-tasks)
                if [ -z "$2" ] || ! [[ "$2" =~ ^[0-9]+$ ]]; then
                    echo -e "${RED}Error: --max-tasks requires a numeric argument${NC}"
                    echo "Usage: ralph --plan --max-tasks 50"
                    exit 1
                fi
                MAX_TASKS="$2"
                shift 2
                ;;
            *)
                INLINE_DESC="$1"
                shift
                ;;
        esac
    done

    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}  Ralph Wiggum - PRD Planning Mode     ${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""

    # Get project description from file or parameter
    PROJECT_DESCRIPTION=""

    if [ -f "$PROJECT_REQUEST_FILE" ]; then
        PROJECT_DESCRIPTION=$(cat "$PROJECT_REQUEST_FILE")
        echo -e "Using project description from: ${YELLOW}${PROJECT_REQUEST_FILE}${NC}"
    elif [ -n "$INLINE_DESC" ]; then
        PROJECT_DESCRIPTION="$INLINE_DESC"
        echo -e "Using project description from parameter"
    else
        echo -e "${RED}Error: No project description provided${NC}"
        echo ""
        echo "Provide a project description either by:"
        echo "  1. Creating a ${YELLOW}project-request.md${NC} file (run 'ralph --init' first)"
        echo "  2. Passing it as a parameter: ${YELLOW}ralph --plan \"Your project description\"${NC}"
        echo ""
        exit 1
    fi

    echo ""
    echo -e "${YELLOW}Starting interactive Claude session to generate PRD...${NC}"
    echo ""

    # The PRD generation prompt
    PLAN_PROMPT="I need you to create a Product Requirements Document (PRD) in JSON format for an AI coding agent to work through.

First, read the CLAUDE.md file in the project root to understand the tech stack and project context.

## Project Idea
${PROJECT_DESCRIPTION}

## Requirements for the PRD

1. **Output Format**: JSON array saved to \`prd.json\`

2. **Structure for each item**:
\`\`\`json
{
  \"id\": 1,
  \"description\": \"Brief description of the feature/task\",
  \"acceptance_criteria\": [
    \"Specific, testable criterion 1\",
    \"Specific, testable criterion 2\"
  ],
  \"passes\": false
}
\`\`\`

3. **Task Sizing** (CRITICAL):
   - Each task must be SMALL and ATOMIC
   - Completable in a single AI context window
   - One focused piece of functionality per task
   - If a feature is large, break it into multiple tasks
   - Maximum ${MAX_TASKS} tasks total (can be less for smaller projects)
   - Balance atomicity with keeping total tasks under ${MAX_TASKS}

4. **Task Independence**:
   - Order tasks by logical dependencies
   - Earlier tasks should not depend on later ones
   - Each task should be verifiable on its own

5. **Acceptance Criteria**:
   - Must be specific and testable
   - Include both positive and negative cases where relevant
   - Think: \"How would I verify this works?\"

6. **Best Practices**:
   - Start with foundational/setup tasks
   - Group related features but keep tasks small
   - Include error handling as separate tasks
   - Consider edge cases as separate tasks if complex
   - Follow the conventions and patterns from CLAUDE.md

## Example Good Task (Small & Focused)
\`\`\`json
{
  \"id\": 5,
  \"description\": \"User can see validation errors on login form\",
  \"acceptance_criteria\": [
    \"Empty email shows 'Email is required' error\",
    \"Invalid email format shows 'Invalid email' error\",
    \"Empty password shows 'Password is required' error\",
    \"Errors clear when user starts typing\"
  ],
  \"passes\": false
}
\`\`\`

## Example Bad Task (Too Large)
\`\`\`json
{
  \"id\": 1,
  \"description\": \"Complete user authentication system\",
  \"acceptance_criteria\": [
    \"User can register, login, logout, reset password, verify email...\"
  ],
  \"passes\": false
}
\`\`\`

Generate the PRD now. Remember: SMALL tasks are critical for success."

    # Run Claude in plan mode to generate the PRD
    (cd "$SCRIPT_DIR" && claude --permission-mode plan "$PLAN_PROMPT")

    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}  PRD Planning Complete!               ${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo -e "Next steps:"
    echo -e "  1. Review ${YELLOW}prd.json${NC}"
    echo -e "  2. Run ${YELLOW}ralph <max_iterations>${NC} to start coding"
    echo ""
    exit 0
fi

# Show help
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "Ralph Wiggum - Autonomous AI Coding Loop (v${RALPH_VERSION})"
    echo ""
    echo "Usage:"
    echo "  ralph <max_iterations>    Run Ralph for N iterations"
    echo "  ralph --once              Run single iteration interactively"
    echo "  ralph --init              Create template files (prd.json, progress.txt, project-request.md)"
    echo "  ralph --reset             Reset template files to initial state"
    echo "  ralph --clean             Remove all Ralph template files"
    echo "  ralph --plan [--max-tasks N] [desc]   Generate PRD (default: 30 tasks max)"
    echo "  ralph --version           Show version information"
    echo "  ralph --update            Update ralph to latest version"
    echo "  ralph --help              Show this help message"
    echo ""
    echo "Examples:"
    echo "  ralph --init              Initialize a new project"
    echo "  ralph --reset             Reset project files to template state"
    echo "  ralph --clean             Remove all Ralph template files"
    echo "  ralph --plan              Generate PRD from project-request.md"
    echo "  ralph --plan \"Build a todo app\"   Generate PRD from description"
    echo "  ralph --plan --max-tasks 50       Generate PRD with up to 50 tasks"
    echo "  ralph 10                  Run 10 autonomous iterations"
    echo "  ralph --once              Run one iteration interactively"
    echo ""
    exit 0
fi

# Validate arguments
if [ -z "$1" ]; then
    echo -e "${RED}Error: Please provide max iterations${NC}"
    echo "Usage: ralph <max_iterations>"
    echo "       ralph --once"
    echo "       ralph --init"
    echo "Example: ralph 10"
    exit 1
fi

MAX_ITERATIONS=$1

# Validate required files exist
if [ ! -f "$PRD_FILE" ]; then
    echo -e "${RED}Error: PRD file not found at ${PRD_FILE}${NC}"
    echo "Run 'ralph --init' to create template files, then 'ralph --plan' to generate PRD."
    exit 1
fi

# Create progress.txt if it doesn't exist
if [ ! -f "$PROGRESS_FILE" ]; then
    echo "# Ralph Progress Log" > "$PROGRESS_FILE"
    echo "# This file tracks learnings across iterations" >> "$PROGRESS_FILE"
    echo "" >> "$PROGRESS_FILE"
fi

# The prompt that guides Claude Code
PROMPT="You are working through a Product Requirements Document (PRD).

Read these files first:
- ${PRD_FILE} - The PRD with user stories (items with passes: false need work)
- ${PROGRESS_FILE} - Your progress log from previous iterations

Your workflow:
1. Find the HIGHEST PRIORITY feature that has passes: false
   - Priority is determined by you based on dependencies and logical order
   - NOT necessarily the first item in the list
2. Work ONLY on that single feature
3. Implement the feature following best practices for the language/framework used
4. Verify your work:
   - Run type checking/linting appropriate for the language
   - Run tests appropriate for the framework
   - Ensure all checks pass before marking complete
5. Update the PRD: set passes: true for completed items
6. APPEND your progress to ${PROGRESS_FILE}
   - Include what you did, decisions made, and notes for next iteration
   - APPEND only, never replace the file contents
7. Make a git commit with a descriptive message

IMPORTANT:
- Work on ONE feature at a time only
- Follow best practices for the language and framework in use
- Ensure CI stays green (all checks and tests pass)
- If you encounter blocking issues, try to resolve them yourself first
- Be resourceful: search for solutions, try alternative approaches, read documentation
- Do NOT add Co-Authored-By or any AI attribution in commit messages
- Do NOT commit Ralph template files (prd.json, progress.txt, project-request.md) - these are local workflow files

COMPLETION SIGNALS:
- If ALL items in the PRD have passes: true, output exactly: RALPH_COMPLETE
- If you are TRULY stuck and cannot proceed after exhausting all options, output exactly: RALPH_NEEDS_HELP
  followed by a clear explanation of:
  1. What you were trying to do
  2. What you tried
  3. Why you cannot proceed
  4. What specific help you need from the human

  Use RALPH_NEEDS_HELP only as a LAST RESORT. Always try to solve problems yourself first."

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  Ralph Wiggum - Autonomous AI Coding  ${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""
echo -e "PRD File: ${YELLOW}${PRD_FILE}${NC}"
echo -e "Progress File: ${YELLOW}${PROGRESS_FILE}${NC}"
echo -e "Max Iterations: ${YELLOW}${MAX_ITERATIONS}${NC}"
echo ""

# Temp file for capturing output
OUTPUT_FILE=$(mktemp)
trap "rm -f $OUTPUT_FILE" EXIT

# Main loop
for ((i=1; i<=MAX_ITERATIONS; i++)); do
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}  Iteration ${i} of ${MAX_ITERATIONS}${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""

    # Run Claude Code with the prompt in the current working directory
    # --dangerously-skip-permissions skips all permission prompts
    # Using tee to both display output and capture it
    (cd "$SCRIPT_DIR" && claude --dangerously-skip-permissions -p "$PROMPT") 2>&1 | tee "$OUTPUT_FILE"

    # Check if PRD is complete
    if grep -q "RALPH_COMPLETE" "$OUTPUT_FILE"; then
        echo ""
        echo -e "${GREEN}========================================${NC}"
        echo -e "${GREEN}  PRD Complete after ${i} iterations!${NC}"
        echo -e "${GREEN}========================================${NC}"

        # Optional: Send notification (uncomment and configure as needed)
        # notify-send "Ralph Complete" "PRD finished after ${i} iterations"
        # curl -X POST "your-webhook-url" -d "Ralph complete after ${i} iterations"

        exit 0
    fi

    # Check if human help is needed
    if grep -q "RALPH_NEEDS_HELP" "$OUTPUT_FILE"; then
        echo ""
        echo -e "${RED}========================================${NC}"
        echo -e "${RED}  Human In The Loop Required           ${NC}"
        echo -e "${RED}========================================${NC}"
        echo ""
        echo -e "${YELLOW}Ralph is stuck and needs your help.${NC}"
        echo -e "${YELLOW}Review the output above for details.${NC}"
        echo ""
        echo -e "After resolving the issue, run ${GREEN}ralph ${MAX_ITERATIONS}${NC} to continue."
        echo ""
        exit 1
    fi

    echo ""
    echo -e "${YELLOW}Iteration ${i} complete. Continuing...${NC}"
    echo ""

    # Small delay between iterations to avoid rate limiting
    sleep 2
done

echo ""
echo -e "${YELLOW}========================================${NC}"
echo -e "${YELLOW}  Max iterations (${MAX_ITERATIONS}) reached${NC}"
echo -e "${YELLOW}  PRD may not be complete${NC}"
echo -e "${YELLOW}========================================${NC}"
